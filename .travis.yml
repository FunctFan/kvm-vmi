---
dist: bionic
language: minimal
git:
  depth: 1
addons:
  apt:
    packages:
      - bridge-utils
      - dnsmasq-base
      - ebtables
      - libvirt-bin
      - libvirt-dev
      - qemu-kvm
      - qemu-utils
      - ruby-dev
      - ansible

# Cache the big Vagrant boxes
cache:
  directories:
  - /home/travis/.vagrant.d/boxes

install:
  - wget -nv https://releases.hashicorp.com/vagrant/2.2.9/vagrant_2.2.9_x86_64.deb -O vagrant.deb
  - sudo dpkg -i vagrant.deb

  - vagrant --version

  - vagrant plugin install vagrant-libvirt
  - vagrant plugin install vagrant-reload

script:
  - pushd vagrant
  # use rsync since NFS doesn't work
  - sed -i -E "s:^(\s*)linux_rsync_type =.*:\1linux_rsync_type = 'rsync':" Vagrantfile
  # we are not in libvirt group, so use sudo
  # also editing NFS exports require root
  - while sleep 9m; do echo "=====[ $SECONDS seconds still running ]====="; done &
  - sudo -E vagrant up --provider=libvirt
  - kill %1
